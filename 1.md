# 🦆 Escape From Duckov Coop Mod Preview 项目说明文档

## 1. 项目概览

**Escape From Duckov Coop Mod Preview（逃离鸭科夫联机模组先遣版）** 是一款让《逃离鸭科夫》(Escape From Duckov) 从单人游戏扩展为多人合作体验的联机模组。:contentReference[oaicite:0]{index=0}  

项目目标是：**在尽量保持原版手感和数值逻辑的前提下，让玩家可以稳定地进行局域网 / 互联网联机合作**。当前已支持：

- 多人游戏进度与状态同步  
- 敌人 AI 行为同步  
- 战利品（Loot）共享与掉落一致性  
- 死亡后的观战模式  
- 完整的战斗与伤害结算同步  
- 局域网与公网环境下的联机支持  

本项目目前仍处于「先遣/预览」阶段，但核心联机功能已经可以完整体验。

---

## 2. 功能总览（玩家视角）

### 2.1 联机玩法核心

- **玩家状态同步**  
  所有玩家的**位置、动作、朝向、装备切换**等会在各客户端之间同步，保证大家看到的是同一场战斗，而不是“各玩各的单机录像”。:contentReference[oaicite:2]{index=2}  

- **AI 敌人同步**  
  敌方单位的**移动、转向、攻击、仇恨目标**在所有玩家之间共享，避免出现“在我这边已经打死，在你那边还活着”的割裂情况。:contentReference[oaicite:3]{index=3}  

- **战利品箱 & 物理世界同步**  
  - 战利品箱的开启状态与掉落内容一致  
  - 门、可破坏物体、投掷物（手雷等）在所有客户端共享当前状态和破坏效果  

- **战斗与死亡体验**  
  - 统一的伤害计算与同步：谁打了多少伤害，由服务器/主机算清楚再广播  
  - 玩家死亡后可进入观战模式，支持自由切换观战目标，并在卡死时一键跳转结算界面  

### 2.2 网络特性

- 支持局域网联机，适合线下开黑  
- 支持公网联机，只要能互相访问 IP/端口即可  
- 内置自动重连与网络状态提示，尽可能降低网络波动对体验的影响  

---

## 3. 近期重要更新：AI / Loot / 地图

这一版本的核心工作集中在三块：**AI 行为升级、Loot 系统重构和地图/流程优化**。

### 3.1 AI 行为与同步升级

**玩家能感受到的变化：**

- 敌人对多名玩家的**威胁感更均衡**，不再长时间“盯死一个人不放”  
- 在复杂地形中的**绕掩体、转火、追击逻辑**更自然，减少原地发呆、卡角落的极端情况  
- 多人视角下的 AI 行为更一致，几个人看同一个怪，动作和反应也更接近  

**背后的技术思路（简要）：**

- **状态机驱动行为**  
  项目大量借助状态机（FSM）来组织 AI 的“巡逻 → 发现敌人 → 追击 → 压制/撤退”等流程，使行为切换有明确的入口和出口，便于在联机环境中做状态同步与恢复。  

- **事件式同步，而非每帧硬同步**  
  AI 的关键事件（进入战斗、切换目标、死亡等）通过网络事件广播，而非每一帧都同步整套内部数据，从而降低带宽占用同时保持行为一致性。  

- **和本地特效/音效解耦**  
  AI 行为状态与表现层（动画、音效、特效）之间用更清晰的接口解耦，联机同步只关心“逻辑正确”，本地再按当前状态驱动展示层，减少网络抖动对观感的影响。  

### 3.2 Loot 系统重构

**玩家能感受到的变化：**

- 同一局游戏中，**所有玩家看到的战利品箱位置一致、内容一致**，极大减少“视觉/掉落不同步”的违和感  
- 开发者/房主可以通过调试输出，快速查看当前地图的所有 Loot 点位，有利于检查是否有“刷不到”“超强刷点”等问题  

**主要改动点：**

1. **统一 Loot 管理入口**  
   - 将原本分散在各地图/脚本中的战利品箱、随机掉落点，收敛到统一的管理模块  
   - 对 Loot 的生成、刷新、开箱结果做统一控制，并在联机时以“主机权威（server-authoritative）”方式向各客户端广播结果  

2. **Loot 调试与可视化工具**  
   - 新增“输出本地图所有战利品箱”的调试指令/按钮，用于快速排查地图资源配置问题
   - 后续可以在此基础上扩展可视化工具（例如在编辑模式下高亮 Loot 点、显示刷新权重等）  

3. **为未来扩展预留结构**  
   当前重构已经为以下玩法预留空间：  
   - 按地图/区域定义不同掉落表  
   - 支持稀有度梯度与动态权重调整  
   - 根据游戏进度或难度动态调整整体收益（例如后期图掉落更危险但更肥）  

### 3.3 地图与流程优化

**玩家能感受到的变化：**

- **地图投票 / 准备流程**  
  在开局前，房主可以发起地图投票，所有玩家在同一界面中完成地图选择与“已准备/未准备”状态确认，不再依赖纯语音沟通。

- **等待与加载提示更清晰**  
  - 进入地图前，如果主机仍在加载，会显示“等待主机加载”等提示  
  - 当主机准备完毕，客户端会看到“主机准备完成，正在入场”等状态，避免玩家误以为游戏卡死:contentReference[oaicite:12]{index=12}  

- **观战与结算流程打磨**  
  死亡后的观战模式加入了详细提示，例如如何切换目标、如何一键跳转结算界面，减少联机场景中“黑屏不知所措”的情况。

**技术实现上的几点：**

- 将“地图加载 → 场景同步 → 玩家入场 → 结束结算”拆分为多个显式阶段，通过状态机/状态枚举记录当前所处阶段，以便在网络重连时做恢复。  
- 利用现有的 UI 文本多语言系统（如 ko-KR.json 中的相关键值）统一控制提示内容，方便以后本地化与文案调整。  

---

## 4. 战斗反馈与表现层改进

虽然本次重点是 AI 与 Loot，但战斗表现也做了同步升级。

### 4.1 本地命中 / 击杀反馈

在联机环境中，完全依赖网络包返回再播放击中效果，会让玩家感觉明显“迟一拍”。为此项目增加了一个本地 FX 层：  

- 利用反射绑定原版的 `HurtVisual` 和 `HitMarker` 组件，在客户端本地命中路径下**直接调用内部的 OnHurt / OnDead / OnHit / OnKill 方法**，尽量保证命中反馈与原版一致。  
- 通过记录最近一次基础伤害值，在某些引擎内部将伤害归一为 1 的路径下，做兜底处理，保证伤害飘字不会永远显示“1.0”。 

### 4.2 对可破坏物体的支持

- 当玩家攻击可破坏物体（例如木板、路障等）时，同样会触发命中/击杀 UI 提示以及伤害飘字，让输出反馈更加统一直观。 
- 在网络层面，这类效果以“本地可预测 + 必要同步”的方式处理，减少简单交互对网络的负担。  

---

## 5. 技术实现概览（给对技术感兴趣的人）

这一节不深入到具体代码，只概括主要技术栈和设计思路。

### 5.1 Mod 架构

- 使用 **HarmonyLib** 对原版游戏进行运行时代码注入（Patch），通过前后缀/替换的方式挂钩关键逻辑，而不直接修改游戏本体文件。  
- 联机逻辑、UI、调试工具等尽量集中在自己的命名空间和程序集，方便后期维护和阅读。  

### 5.2 网络层

- 基于 **LiteNetLib** 的 UDP 网络通讯层，提供：
  - 会话建立与心跳机制  
  - 可靠/不可靠消息通道区分（重要状态走可靠通道，像位置信息可以用不可靠通道节省带宽）  
  - 断线重连与错误提示  

- 在上层协议中，尽可能采用**事件驱动**模式：  
  - 例如“怪物进入战斗”“玩家被击倒”“战利品箱被打开”都作为事件广播  
  - 位移、朝向等高频数据则以插值+压缩方式更新  

### 5.3 行为逻辑与状态机

- AI 与部分游戏流程（如地图加载、观战/结算）使用 **状态机（FSM, Finite State Machine）** 描述，将复杂流程拆解为多个明确的状态节点和转移条件，方便：
  - 在联机环境中只同步必要的状态  
  - 在调试时快速定位“卡在某个状态”的问题  

### 5.4 声音与 UI 系统

- 利用游戏自带的 FMOD 音频系统，并通过扩展组件 `AudioObject` 实现自定义音效、动态参数调整等能力，在不破坏原有声音结构的前提下扩展 Coop 相关提示音。  
- UI 文案统一走本地化表（如 `ko-KR.json`），使网络状态、地图投票、观战提示等内容可以方便地本地化到多种语言。  

---

## 6. 项目状态与后续方向

- 当前版本定位为 **“功能可用的先遣版”**：主要联机能力已经可玩，但仍可能存在边缘同步问题和性能可优化空间。
- 后续方向包括：
  - 覆盖更多游戏机制的同步支持  
  - 在大人数/高延迟场景下的性能与稳定性优化  
  - 完善的错误处理与用户提示  
  - 更细致的文档与开发者指南（包括协议层说明与扩展示例）:contentReference[oaicite:24]{index=24}  

---

如果你是玩家，只需要在 Steam 创意工坊订阅并启用本模组即可体验联机；如果你是开发者，可以直接克隆本仓库、按照编译指南构建并阅读源码，参与改进。  
